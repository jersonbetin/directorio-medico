extends layout

block css
  link(rel="stylesheet", href='/stylesheets/less/home/general.css')
  link(rel="stylesheet", href='/stylesheets/less/information/information.css')

block nav
  button.navbar-toggle(type="button", data-toggle="collapse", data-target="#bs-example-navbar-collapse-1")
    span.sr-only toogle navigation
    span.icon-bar
    span.icon-bar
    span.icon-bar
  a.navbar-brand(href='/') CONSULTING
  #bs-example-navbar-collapse-1.navbar-collapse.collapse
    ul.nav.navbar-nav
      li
        a(href="/") 
          i.fa.fa-bars
          |  Dashboard
      li.dropdown
        a(href="#", class="dropdown-toggle", data-toggle="dropdown") 
          i.fa.fa-info-circle
          |   Mi informacion
          b.caret
        ul.dropdown-menu
          li
            a(href="/me/personal_information")
              i.fa.fa-star
              |   Personal
          li.active
            a()
              i.fa.fa-star
              |  Profesional
          li
            a(href="/me/titles_information")
              i.fa.fa-star
              |  Titulos
          li
            a(href="/me/register_end")
              i.fa.fa-star
              |  finalizar registro
      li
        a#logout_doctor(href="#")
          i.fa.fa-sign-out
          |  Cerrar session

block content
  .container.general-content
    .row
      .col-lg-12
        .page-header.title-header
           h1 Informacion Profesional
      .col-lg-9
        form#perosnal_information_form
          input#csrf_input(type="hidden", value="#{data.csrf}")
          table.table
            #alert_registrado.alert-info
              span Usuario registrado En secretaria de salud y se cargaron los datos personales en el formulario
            #alert_no_registrado.alert-info
              span Usuario no esta registrado tiene que guardar sus datos y enviarlos a la secretaria de salud
            .form-group
              tr
                td
                  label(for="professional_card_number_input", class="control-label") Numero de la targeta profesional: 
                td
                  input(type="text", class="form-control", id="professional_card_number_input", placeholder="Numero de la targeta profesional", required)
                td
                  label(for="evidence_input", class="control-label") Evidencia: 
                td
                  input(type="file", id="evidence_input", class="form-control", accept="application/pdf", required)
            .form-group
              tr
                td
                  label(for="professional_type_input", class="control-label") Tipo de profesion: 
                td
                  #div_professional_type
                td
                  label(for="is_working_input", class="control-label") Esta trabajando?: 
                td
                  select(id="is_working_input", class="form-control", required)
                    option(value="si") Si
                    option(value="no") No
            .form-group
              tr
                td
                  label(for="nit_clinica", class="control-label") Nit: 
                td
                  input(type="text", id="nit_clinica", class="form-control", placeholder="Nit de la clinica", required)
                td
                  label(for="name_clinica", class="control-label") Nombre de la clinica: 
                td
                  input(type="text", id="name_clinica", class="form-control", placeholder="Nombre de la clinica", required)
            .form-group
                tr
                  td
                    label(for="city_clinica", class="control-label") Ciudad: 
                  td
                    #div_municipios_clinica
                  td
                    label(for="address_clinica", class="control-label") Direccion de la clinica: 
                  td
                    input(type="text", id="address_clinica", class="form-control", placeholder="direccion de la clinca", required)
            .form-group
                tr
                  td
                    label(for="landline_clinica", class="control-label") Telefono: 
                  td
                    input(type="text", id="landline_clinica", class="form-control", placeholder="Telefono de la clinica", required)
                  td
                    label(for="mobile_clinica", class="control-label") Celular: 
                  td
                    input(type="text", id="mobile_clinica", class="form-control", placeholder="Celular de la clinca", required)
            .form-group
              tr
                td
                td
                  button.btn.btn-primary.col-lg-12(type="submit", id="button_save_professional_information_form") Guardar
                td
                   button.btn.btn-default.col-lg-12(type="reset") Borrar
      .col-lg-3
        img(src="/images/profesion.png", alt="", style="width:100%;")

       #myModal.modal.fade(tabindex="-1", role="dialog", aria-labelledby="myLargeModalLabel", aria-hidden="true")
            .modal-dialog.modal-lg( style="width: 60%;")
              .modal-content
                .modal-header
                  button(type="button", class="close", data-dismiss="modal", aria-hidden="true")&times;
                  h4(class="modal-title", id="myModalLabel") Verificar en secretaria de salud
                .modal-body
                  form(name="inf-otros", id="inf-otros", method="post", action="/medicos/inf-otros")
                    table.table
                      .form-group
                        tr
                          td
                          td
                            label.control-label.col-sm-12(for="identification") Cedula:
                          td
                            input.form-control#identification(type="text", placeholder="cedula", required)
                          td
                    .modal-footer
                        button(type="button", class="btn btn-default", data-dismiss="modal") Cancelar
                        button(type="submit", id="verify_identification_button", class="btn btn-primary") Consultar

block js
  script.
    $(document).on("ready", function(){
    function logoutDoctorSuccess(data, textStatus, jqXHR){
        console.log(data);
        if(data){
          if(data.error){
            console.log(error);
          }else{
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            localStorage.removeItem("tokenType");
            localStorage.removeItem("expirationDate");
            window.location.replace("/");
          }
        }
      }

    $(function municipios(){
        $.ajax({
          method:'get',
          url:'/municipios',
          success:function(data){
            var select = '<select class="form-control" name="city_clinica" id="city_clinica">';
            for(var i=0; i<data.municipios.length;i++){
              select+='<option value="'+data.municipios[i]._id+'">'+data.municipios[i].name+'</option>';
            }
            select += '</select>';
            document.getElementById('div_municipios_clinica').innerHTML=select;
          }
        });
      });
      $(function tipo_profesional(){
        $.ajax({
            method:'get',
            dataType: 'json',
            url:'http://localhost:4000/tipoProfesional',
            success:function(data){
              console.log(data);
              var profesionales=data.profesionales;
              var select = '<select class="form-control" name="professional_type_input" id="professional_type_input">';
              for(var i=0; i<profesionales.length;i++){
                select+='<option value="'+profesionales[i]._id+'">'+profesionales[i].tipo+'</option>';
              }
              select += '</select>';
              document.getElementById('div_professional_type').innerHTML=select;
            }
          });
        });
      
      $("#logout_doctor").on('click', function(e){
        e.preventDefault();
        $.ajax({
          type: "DELETE",
          url:"/login/doctors",
          headers: {
            "csrfToken": $("#csrf_input").val()
          },
          success: logoutDoctorSuccess
        });
      }); // End of logout doctor on click event

      $("#button_save_professional_information_form").on("click", function(e) {
        e.preventDefault();
        var requestType = "POST";
        if($(this).html() == "Actualizar"){
          console.log("Si es Actualizar");
          requestType = "PUT";
        }

        var professionalCardNumber = $("#professional_card_number_input").val();
        var professionalType = $("#professional_type_input").val();
        var isWorking = $("#is_working_input").val();
        console.log(isWorking);
        var inputFileImage = document.getElementById("evidence_input");
        var evidence  = inputFileImage.files[0]; 
        console.log(evidence);
        var nit= $('#nit_clinica').val();
        var name_clinica=$('#name_clinica').val();
        var city_clinica=$('#city_clinica').val();
        var address_clinica=$('#address_clinica').val();
        var mobile_clinica=$('#mobile_clinica').val();
        var landline_clinica=$('#landline_clinica').val();
        if(professionalCardNumber != "" && professionalType != "" && is_working_input != "" && evidence != ""){
          console.log("se pasaron todos los datos");
          e.preventDefault();
          var data = new FormData();
          data.append("professionalCard.number", professionalCardNumber);
          data.append("professionalType", professionalType);
          data.append("isWorking", isWorking);
          data.append("evidence", evidence);
          if(isWorking=='si'){
            data.append("clinic.nit", nit);
            data.append("clinic.name", name_clinica);
            data.append("city_clinica", city_clinica);
            data.append("address_clinica", address_clinica);
            data.append("mobile_clinica", mobile_clinica);
            data.append("landline_clinica", landline_clinica);
          }
          console.log(data);
          $.ajax({
            type: requestType,
            url:"/api/v1/doctors/me/professional_information?errors=verbose",
            headers: {
              "accessToken": localStorage.accessToken
            },
            data: data, 
            processData: false, // Don't process the files
            contentType: false, 
            success: function(data){
              console.log(data);
            }
          });
        }else{
          console.log("No se pasaron todos los datos")
        }
      });

      function getDoctorProfessionalInformation(){
        $.ajax({
          url:"/api/v1/doctors/me/professional_information",
          headers: {
            "accessToken": localStorage.accessToken
          },
          success: function(data){
            console.log(data);
            if(data.doctorProfessionalInformation){
              console.log(data.doctorProfessionalInformation);
              $("#professional_card_number_input").val(data.doctorProfessionalInformation.professionalCard.number);
              $("#professional_type_input").val(data.doctorProfessionalInformation.professionalType);
              $("#is_working_input").val(data.doctorProfessionalInformation.isWorking);
              //$("#evidence_input").val(data.doctorProfessionalInformation.evidence);
              $("#button_save_professional_information_form").html("Actualizar");
              if(data.doctorProfessionalInformation.isWorking=='si'){
                $('#nit_clinica').attr('disabled',false);
                $('#name_clinica').attr('disabled',false);
                $('#city_clinica').attr('disabled',false);
                $('#address_clinica').attr('disabled',false);
                $('#mobile_clinica').attr('disabled',false);
                $('#landline_clinica').attr('disabled',false);
                $('#nit_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.nit);
                $('#name_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.name);
                $('#city_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.location.city);
                $('#address_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.location.address);
                $('#mobile_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.phone.mobile);
                $('#landline_clinica').val(data.doctorProfessionalInformation.jobInformation.clinic.phone.landline);
              }else{
                $('#nit_clinica').attr('disabled',true);
                $('#name_clinica').attr('disabled',true);
                $('#city_clinica').attr('disabled',true);
                $('#address_clinica').attr('disabled',true);
                $('#mobile_clinica').attr('disabled',true);
                $('#landline_clinica').attr('disabled',true);
                $('#nit_clinica').val('');
                $('#name_clinica').val('');
                //$('#city_clinica').val('');
                $('#address_clinica').val('');
                $('#mobile_clinica').val('');
                $('#landline_clinica').val('');
              }
            }else{
              console.log("No se ha guardado aun informacion personal de este doctor");
              $('#myModal').modal();
            }
            //- if (data.userdataDoctor){
            //-   console.log(data.userdataDoctor):
            //- }
          }
        });
      }

      $('#is_working_input').on('change', function(){
          if($(this).val()=="no"){
            $('#nit_clinica').attr('disabled',true);
            $('#name_clinica').attr('disabled',true);
            $('#city_clinica').attr('disabled',true);
            $('#address_clinica').attr('disabled',true);
            $('#mobile_clinica').attr('disabled',true);
            $('#landline_clinica').attr('disabled',true);
          }else{
          $('#nit_clinica').attr('disabled',false);
          $('#name_clinica').attr('disabled',false);
            $('#city_clinica').attr('disabled',false);
            $('#address_clinica').attr('disabled',false);
            $('#mobile_clinica').attr('disabled',false);
            $('#landline_clinica').attr('disabled',false);
          }
        });

      $("#verify_identification_button").on("click", function(e){
        e.preventDefault();
        console.log("click click click");
        console.log($("#identification").val());
        e.preventDefault();
        $.ajax({
          type: "GET",
          url:"/secretary/verify/"+$("#identification").val(),
          headers: {
            "csrfToken": $("#csrf_input").val()
          },
          success: function(data){
              console.log(data);
              var medico=data.data;
              console.log(medico.registrado);
              if(medico.estado=="no registrado"){
                $('.close').trigger('click');
                $('#alert_no_registrado').css('display', 'block');
              }else if(medico.registrado == "si"){
                $('.close').trigger('click');
                $('#alert_registrado').css('display', 'block');
                var profesional=medico.infoPersonal;
                $("#professional_card_number_input").val(profesional.tarjetaPofesional);
                $("#professional_card_number_input").attr('readonly', true);
                $("#professional_type_input").val(profesional.tipoProfesional);
                $('#evidence_input').attr('disabled',true);
            }else{
              alert("hubo un error xp");
            }
          }
        });
      });

      getDoctorProfessionalInformation();
    }); // End of document on ready event